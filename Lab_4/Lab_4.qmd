---
title: Исследование метаданных DNS трафика
author: "p.pluvkov@yandex.ru"
format: 
  md:
    output-file: README.md
---

## Цель работы
1. Зекрепить практические навыки использования языка программирования R для обработки данных
2. Закрепить знания основных функций обработки данных экосистемы tidyverse языка R
3. Закрепить навыки исследования метаданных DNS трафика

## Исходные данные
1. Програмное обеспеченье MacOS
2. RStudio
3. Интерпретатор языка R 4.5.1
4. Файл dns.log

## План

Используя программный пакет dplyr, проанализировать
DNS лог с помощью языка программирования R.

## Подготовка данных

0. Импорт библиотек

```{r setup, include=FALSE}
#| label: q1
options(repos = c(CRAN = "https://cloud.r-project.org/"))
```

```{R}
#| label: q2
library(dplyr)
library(readr)
```

1. Добавьте пропущенные данные о структуре данных (назначении столбцов)

```{r}
#| label: q3
fields <- fields <- c(
  "timestamp", "uid", "src_ip", "src_port", "dst_ip", "dst_port",
  "protocol", "transaction_id", "domain", "unused",
  "qclass", "qclass_id", "qtype", "qtype_id",
  "rcode", "rcode_name", "flag_AA", "flag_TC",
  "flag_RD", "flag_RA", "flag_Z", "answers", "ttls"
)
```

2. Преобразуйте данные в столбцах в нужный формат

```{r}
#| label: q4
dns_data <- read_tsv(
  file = "dns.log",
  col_names = fields,
  col_types = cols(
    .default = col_character(),
    timestamp = col_double(),
    src_port = col_integer(),
    dst_port = col_integer(),
    transaction_id = col_integer(),
    qclass_id = col_integer(),
    qtype_id = col_integer(),
    flag_AA = col_logical(),
    flag_TC = col_logical(),
    flag_RD = col_logical(),
    flag_RA = col_integer()
  ),
  na = c("-", "(empty)", ""),
  comment = "#",
  show_col_types = FALSE
)
```

3. Просмотрите общую структуру данных с помощью функции glimpse()

```{r} 
glimpse(dns_data)
```

## Анализ данных

### Шаг 1. Cколько участников информационного обмена в сети Доброй Организации?

```{r}
all_hosts <- dns_data %>%
  select(src_ip, dst_ip) %>%
  unlist(use.names = FALSE) %>%
  unique()

length(all_hosts)
glimpse(all_hosts)
``` 

### Шаг 2. Какое соотношение участников обмена внутри сети и участников обращений к внешним ресурсам?
```{r}
internal_cnt <- sum(grepl("^(10\\.|192\\.168\\.|172\\.(1[6-9]|2[0-9]|3[0-1])\\.)", all_hosts))
external_cnt <- length(all_hosts) - internal_cnt

internal_cnt / external_cnt
```

### Шаг 3. Найдите топ-10 участников сети, проявляющих наибольшую сетевую активность.
```{r}
dns_data %>%
  count(src_ip, sort = TRUE) %>%
  slice_head(n = 10)
```

### Шаг 4. Найдите топ-10 доменов, к которым обращаются пользователи сети и соответственное количество обращений

```{r}
dns_data %>%
  count(domain, sort = TRUE) %>%
  slice_head(n = 10)
```

### Шаг 5. Опеределите базовые статистические характеристики (функция summary() ) интервала времени между последовательными обращениями к топ-10 доменам.

```{R}
interval_stats <- dns_data %>%
  count(domain, name = "req_total") %>%
  slice_max(req_total, n = 10) %>%
  left_join(dns_data, by = "domain") %>%
  arrange(domain, timestamp) %>%
  group_by(domain) %>%
  summarise(
    min_gap = min(diff(timestamp)),
    q1_gap = quantile(diff(timestamp), 0.25),
    median_gap = median(diff(timestamp)),
    mean_gap = mean(diff(timestamp)),
    q3_gap = quantile(diff(timestamp), 0.75),
    max_gap = max(diff(timestamp)),
    sd_gap = sd(diff(timestamp)),
    .groups = "drop"
  ) %>%
  arrange(median_gap)

interval_stats
```

### Шан 6. По периодическим запросам на один и тот же домен можно выявить скрытый DNS канал. Есть ли такие IP адреса в исследуемом датасете?

```{R}
tmp_hosts <- dns_data %>%
  semi_join(
    dns_data %>% count(domain) %>% slice_max(n, n = 10),
    by = "domain"
  ) %>%
  group_by(src_ip, domain) %>%
  filter(n() >= 5) %>%
  arrange(timestamp) %>%
  summarise(
    total = n(),
    avg_int = mean(diff(timestamp)),
    sd_int = sd(diff(timestamp)),
    cv = sd_int / avg_int,
    ratio = max(diff(timestamp)) / min(diff(timestamp)),
    .groups = "drop"
  ) %>%
  filter(cv < 0.5, total >= 10, ratio < 10) %>%
  arrange(cv)

tmp_hosts
```

### Шаг 7.  Определите местоположение (страну, город) и организацию-провайдера для топ-10 доменов.
```{R}
# Определяем функцию get_geo_info_debug
get_geo_info <- function(ip) {
  if (is.na(ip) || ip == "" || grepl(":", ip)) return(NULL)
  tryCatch({
    r <- httr::GET(paste0("http://ip-api.com/json/", ip), httr::timeout(5))
    if (httr::status_code(r) != 200) return(NULL)
    d <- httr::content(r, "parsed")
    if (d$status != "success") return(NULL)
    data.frame(
      ip = ip,
      country = d$country,
      city = d$city,
      isp = d$isp,
      org = d$org
    )
  }, error = function(e) NULL)
}

popular_domains <- dns_data %>% count(domain, sort = TRUE) %>% slice_head(n = 10)
popular_domains

```

## Оценка результата
1. Зекрепили практические навыки использования языка программирования R для обработки данных
2. Закрепили знания основных функций обработки данных экосистемы tidyverse языка R
3. Закрепили навыки исследования метаданных DNS трафика

## Вывод
В рамках работы, используя программный пакет dplyr, проанализировали DNS лог с помощью языка программирования R.


























